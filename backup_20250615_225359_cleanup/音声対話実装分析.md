# 🎤 Discord音声対話システム実装分析

## 📊 現状把握

### ✅ **完成済み機能**
- Discord Bot基本フレームワーク
- テキストチャット機能
- VOICEVOX音声合成・出力
- 基本コマンド処理（!join, !guide等）

### 🔧 **部分実装済み**
- ホットキー検出システム（pynput使用）
- VoiceRecordingSinkクラス（骨組み）
- 音声認識基盤（SpeechRecognition）

### ❌ **未実装・問題あり**
- Discord音声データ受信・変換
- リアルタイム音声認識処理
- 音声→テキスト→応答→音声の完全パイプライン
- Windows環境でのマイク権限・音声デバイス統合

---

## 🎯 実装方針と優先順位

### **Phase 1: 基盤機能確立（高優先度）**

#### 1.1 Discord音声受信パイプライン
**課題:**
- `discord.sinks` モジュール非互換
- PCM → WAV変換処理
- ユーザー音声の分離・識別

**実装方針:**
```python
# カスタムVoiceRecordingSink改良
class VoiceRecordingSink:
    def write(self, data, user):
        # PCMデータ蓄積・リアルタイム処理
        # ユーザー別音声データ管理
        # 音声認識トリガー判定
```

#### 1.2 Windows環境音声認識統合
**課題:**
- PyAudio vs arecord fallback
- マイク権限・デバイス検出
- WSL2 vs Windows実行環境の違い

**実装方針:**
```python
# 環境検出・フォールバック機能
def get_audio_engine():
    if windows_environment:
        return PyAudioEngine()
    else:
        return SubprocessAudioEngine()  # arecord等
```

### **Phase 2: リアルタイム処理（中優先度）**

#### 2.1 音声認識エンジン最適化
**課題:**
- 認識精度vs応答速度
- 日本語特化設定
- ノイズ除去・音声品質向上

**実装方針:**
```python
# Google Speech Recognition日本語設定
recognizer.recognize_google(audio, language='ja-JP')
# Whisper APIフォールバック
# 音声前処理（ノイズ除去等）
```

#### 2.2 Ctrl+Shift+Altホットキー統合
**課題:**
- Discord音声とローカル音声の使い分け
- 権限エラー・キー検出失敗
- 録音開始/停止タイミング制御

**実装方針:**
```python
# 統合音声入力クラス
class UnifiedVoiceInput:
    def __init__(self):
        self.discord_voice = DiscordVoiceInput()
        self.hotkey_voice = HotkeyVoiceInput()
    
    def start_listening(self, mode='auto'):
        # Discord優先、フォールバックでローカル
```

### **Phase 3: ユーザー体験向上（低優先度）**

#### 3.1 音声対話フロー改善
- 音声認識中の視覚的フィードバック
- 応答生成中の待機表示
- エラー時の自動復旧

#### 3.2 パフォーマンス最適化
- 音声キャッシュ活用
- 並列処理によるレスポンス向上
- メモリ使用量最適化

---

## 🔧 技術的実装戦略

### **アーキテクチャ設計**

```
Discord User Audio Input
         ↓
[VoiceRecordingSink] ← Discord音声データ受信
         ↓
[AudioProcessor] ← PCM→WAV変換・音声品質向上
         ↓
[SpeechRecognizer] ← Google/Whisper API
         ↓
[SetsunaChat] ← GPT応答生成
         ↓
[VoiceOutput] ← VOICEVOX音声合成
         ↓
Discord Audio Playback
```

### **フォールバック戦略**

1. **音声入力**: Discord音声 → ローカルマイク → テキスト入力
2. **音声認識**: Google → Whisper → パターンマッチング
3. **音声出力**: Discord再生 → ローカル再生 → テキスト表示

### **エラーハンドリング**

```python
class VoiceDialogManager:
    async def handle_voice_input(self, audio_data):
        try:
            # メイン処理
            return await self.process_voice(audio_data)
        except AudioRecognitionError:
            return await self.fallback_text_input()
        except VoiceOutputError:
            return await self.fallback_text_output()
        except Exception as e:
            return await self.emergency_fallback(e)
```

---

## 📋 実装チェックリスト

### **Milestone 1: 基本音声対話**
- [ ] Discord音声受信機能実装
- [ ] PCM→WAV変換安定化
- [ ] 基本音声認識パイプライン
- [ ] 音声→応答→音声の1サイクル実現

### **Milestone 2: ホットキー統合**
- [ ] Ctrl+Shift+Alt検出改良
- [ ] Windows環境マイク統合
- [ ] Discord/ローカル音声の自動切換

### **Milestone 3: 製品レベル品質**
- [ ] エラー耐性・自動復旧
- [ ] 音声品質最適化
- [ ] パフォーマンス調整
- [ ] ユーザビリティ改善

---

## 🚧 既知の技術的制約

### **Discord API制限**
- 音声データは48kHz/16bit/Stereo PCM
- リアルタイム処理には最適化が必要
- ボットの音声送信は全ユーザーに配信

### **Windows環境特有の課題**
- マイク権限管理
- PyAudio vs システム音声API
- WSL2 vs Native Windows実行

### **音声認識精度**
- 背景ノイズ・音質の影響
- 日本語特有の認識課題
- リアルタイム vs 高精度のトレードオフ

---

## 🎯 次回実装ステップ

1. **VoiceRecordingSink改良** - Discord音声受信機能完成
2. **音声認識パイプライン統合** - PCM処理→認識→応答の1サイクル
3. **Windows環境テスト** - 実際の音声対話動作確認
4. **ホットキー機能統合** - Ctrl+Shift+Alt操作の完全実装

**目標:** 次回セッションで基本的な音声対話（Discord音声入力→せつな応答→音声出力）を実現する